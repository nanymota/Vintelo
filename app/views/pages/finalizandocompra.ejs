<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vintélo - Finalizar Compra</title>
  <link rel="stylesheet" href="/css/finalizandocompra.css">
  <link rel="stylesheet" href="/css/finalizando2.css">

  <link rel="icon" href="/imagens/brilhoescuro.png" type="image/x-icon">
</head>
<body>
  <!-- Mobile Version -->
  <section class="oculto-desktop">
    <header>
      <nav class="grid">
        <a href="javascript:void(0)" onclick="goBack()">
          <img src="/imagens/seta.png" alt="Voltar">
        </a>
        <h1>Finalizar Compra</h1>
        <% if (autenticado && autenticado.imagem) { %>
          <a href="javascript:void(0)" onclick="goBack()">
            <img src="/<%= autenticado.imagem %>" alt="Perfil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
        <% } else { %>
          <a href="javascript:void(0)" onclick="goBack()">
            <img src="/imagens/icone sem cadastro.png" alt="Perfil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          </a>
        <% } %>
      </nav>
    </header>

    <main>
      <!-- Products Section -->
      <section class="product-section">
        <% if (carrinho && carrinho.length > 0) { %>
          <% const uniqueItems = carrinho.filter((item, index, self) => 
               index === self.findIndex(i => i.produto_id === item.produto_id)); %>
          <% uniqueItems.forEach((item) => { %>
            <article class="product-card1" data-product-id="<%= item.produto_id %>">
              <img src="<%= item.imagem %>" alt="<%= item.nome %>" class="product-img" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover;">
              <section class="produto-info">
                <h3><%= item.nome %></h3>
                <% if (item.cor) { %><p>Cor: <%= item.cor %></p><% } %>
                <% if (item.estilo) { %><p>Estilo: <%= item.estilo %></p><% } %>
                <% if (item.tamanho) { %><p>Tamanho: <%= item.tamanho %></p><% } %>
                <p class="preco">R$<%= parseFloat(item.preco || 0).toFixed(2).replace('.', ',') %></p>
                <section class="quantity-control">
                  <button class="qty-btn" onclick="decreaseQuantity('<%= item.produto_id %>')">-</button>
                  <span class="quantity" id="qty-<%= item.produto_id %>"><%= item.quantidade %></span>
                  <button class="qty-btn" onclick="increaseQuantity('<%= item.produto_id %>')">+</button>
                </section>
              </section>
              <button class="remove-item" onclick="removeItem('<%= item.produto_id %>')">
                <img src="/imagens/lixeira.png" class="lixeira">
              </button>
            </article>
          <% }) %>
        <% } %>
      </section>

      <!-- Shipping Section -->
      <section class="shipping-section">
        <h4>Calcular frete</h4>
        <section class="frete-input">
          <input type="text" id="cep_frete" placeholder="00000-000" maxlength="9" oninput="formatCEPFrete(this)">
          <button onclick="calcularFrete()" class="btn-calcular">Calcular</button>
        </section>
        <section id="frete-loading" style="display: none;">
          <p>Calculando frete...</p>
        </section>
        <section id="frete-result"></section>
      </section>

      <!-- Order Info -->
      <section class="order-info">
        <h4>Informações do pedido</h4>
        <section class="order-details">
          <p>Subtotal</p><p id="subtotal">R$<%= subtotal || '0,00' %></p>
          <p>Frete</p><p id="shipping-cost">R$<%= frete || '0,00' %></p>
          <p>Desconto</p><p id="discount">R$0,00</p>
          <p><strong>Total</strong></p><p><strong id="total">R$<%= total || '0,00' %></strong></p>
        </section>
      </section>

      <!-- Discount Section -->
      <section class="discount-section">
        <h4>Inserir cupom de desconto</h4>
        <form class="discount-input">
          <input type="text" placeholder="Digite o cupom">
          <button class="apply-button">Inserir</button>
        </form>
      </section>

      <!-- Suggestions -->
      <section class="suggestions-section">
        <h4>Adicione mais à sacola</h4>
        <div class="carousel-container">
          <ul class="product-list carousel-list">
            <% if (produtosSugeridos && produtosSugeridos.length > 0) { %>
              <% produtosSugeridos.forEach(produto => { %>
                <li class="product-suggestion">
                  <img src="<%= produto.imagem %>" alt="<%= produto.NOME_PRODUTO %>">
                  <p><%= produto.NOME_PRODUTO %></p>
                  <p>R$<%= parseFloat(produto.PRECO || 0).toFixed(2).replace('.', ',') %></p>
                  <button class="adicionar-compra" data-produto-id="<%= produto.ID_PRODUTO %>">Adicionar</button>
                </li>
              <% }) %>
            <% } else { %>
              <li class="product-suggestion">
                <img src="/imagens/conjunto.png" alt="Saia Branca">
                <p>Saia Branca</p>
                <p>R$25,00</p>
                <button class="adicionar-compra">Adicionar</button>
              </li>
            <% } %>
          </ul>
        </div>
        <a href="/favoritos" class="link-branco"><p class="favorites-link">Conferir peças favoritas ></p></a>
      </section>

      <% if (produto && produto.produto_id) { %>
        <a href="/finalizandopagamento?produto=<%= produto.produto_id %>"><button class="finalizar-compra">Finalizar Compra</button></a>
      <% } else { %>
        <a href="/finalizandopagamento"><button class="finalizar-compra">Finalizar Compra</button></a>
      <% } %>
    </main>
  </section>

  <!-- Desktop Version -->
  <section class="oculto-mobile">
    <header>
      <section class="top-bar">
        <p>10% OFF na primeira compra</p>
      </section>
      <section class="main-header">
        <a href="/homecomprador">
          <img src="/imagens/logo.png" class="img-logo">
        </a>
        <nav>
          <a href="/categorias">Vestidos</a>
          <a href="/categorias">Saias</a>
          <a href="/categorias">Blusas</a>
          <a href="/categorias">Calças</a>
          <a href="/categorias">Outros</a>
        </nav>
        <section class="search-profile">
          <form>
            <input type="text" placeholder="Buscar...">
          </form>
          <ul>
            <li><a href="/criarbrecho"><img src="imagens/add brecho.png" class="img-tamanho"></a></li>
            <li><a href="/perfilcliente">
              <% if (autenticado && autenticado.imagem) { %>
                <img src="/<%= autenticado.imagem %>" class="maria">
              <% } else { %>
                <img src="imagens/icone sem cadastro.png" class="img-tamanho">
              <% } %>
            </a></li>
            <li><a href="/favoritos"><img src="imagens/icone coraçao.png" class="img-tamanho"></a></li>
          </ul>
        </section>
      </section>
    </header>

    <section class="sacola-container">
      <h1 class="adicionar">Finalizar Compra</h1>
      <section class="sacola-content">
        <% if (carrinho && carrinho.length > 0) { %>
          <% const uniqueItems = carrinho.filter((item, index, self) => 
               index === self.findIndex(i => i.produto_id === item.produto_id)); %>
          <% uniqueItems.forEach((item) => { %>
            <section class="produto-card" data-product-id="<%= item.produto_id %>">
              <img src="<%= item.imagem %>" alt="<%= item.nome %>" style="width: 120px; height: 120px; border-radius: 12px; object-fit: cover;">
              <section class="produto-info">
                <h2><%= item.nome || 'Produto não encontrado' %></h2>
                <% if (item.cor) { %><p>Cor: <%= item.cor %></p><% } %>
                <% if (item.estilo) { %><p>Estilo: <%= item.estilo %></p><% } %>
                <% if (item.tamanho) { %><p>Tamanho: <%= item.tamanho %></p><% } %>
                <p class="preco">R$<%= parseFloat(item.preco || 0).toFixed(2).replace('.', ',') %></p>
                <section class="quantity-control-desktop">
                  <button class="qty-btn" onclick="decreaseQuantity('<%= item.produto_id %>')">-</button>
                  <span class="quantity" id="qty-<%= item.produto_id %>"><%= item.quantidade %></span>
                  <button class="qty-btn" onclick="increaseQuantity('<%= item.produto_id %>')">+</button>
                </section>
              </section>
              <button class="remove-btn" onclick="removeItem('<%= item.produto_id %>')">
                <img src="/imagens/lixeira.png" class="lixeira2">
              </button>
            </section>
          <% }) %>
        <% } else { %>
          <p>Nenhum produto selecionado. <a href="/homecomprador">Escolher produto</a></p>
        <% } %>
        


        <section class="pedido-info">
          <!-- Cálculo de Frete Desktop -->
          <section class="frete-calculator">
            <h4>Calcular frete</h4>
            <section class="frete-input">
              <input type="text" id="cep_frete_desktop" placeholder="00000-000" maxlength="9" oninput="formatCEPFrete(this)">
              <button onclick="calcularFreteDesktop()" class="btn-calcular">Calcular</button>
            </section>
            <section id="frete-loading-desktop" style="display: none;">
              <p>Calculando frete...</p>
            </section>
            <section id="frete-result-desktop"></section>
          </section>
          
          <h2>Informações do pedido</h2>
          <section class="pedido-detalhes">
            <section class="detalhe">
              <span>Subtotal</span>
              <span>R$ <%= subtotal || '0,00' %></span>
            </section>
            <section class="detalhe">
              <span>Frete</span>
              <span>R$ <%= frete || '0,00' %></span>
            </section>
            <section class="detalhe">
              <span>Desconto</span>
              <span>R$ 0,00</span>
            </section>
            <section class="detalhe total">
              <span>Total</span>
              <span>R$ <%= total || '0,00' %></span>
            </section>
          </section>
          <section class="cupom">
            <input type="text" placeholder="Inserir cupom de desconto">
            <button>Inserir</button>
          </section>
          <% if (produto && produto.produto_id) { %>
            <a href="/finalizandopagamento?produto=<%= produto.produto_id %>"><button class="finalizar-compra">Finalizar Compra</button></a>
          <% } else { %>
            <a href="/finalizandopagamento"><button class="finalizar-compra">Finalizar Compra</button></a>
          <% } %>
        </section>
      </section>
    </section>

    <!-- Product Suggestions -->
    <section class="produtos-ocultos">
      <h1 class="adicionar">Adicione mais à sacola</h1>
      <section class="product-grid">
        <% if (produtosSugeridos && produtosSugeridos.length > 0) { %>
          <% produtosSugeridos.forEach(produto => { %>
            <article class="product-card">
              <a href="/produto/<%= produto.ID_PRODUTO %>">
                <img src="<%= produto.imagem %>" alt="<%= produto.NOME_PRODUTO %>">
              </a>
              <h2><%= produto.NOME_PRODUTO %></h2>
              <p class="price">R$ <%= parseFloat(produto.PRECO || 0).toFixed(2).replace('.', ',') %></p>
              <p class="Descrição">ou em 2x de R$ <%= (parseFloat(produto.PRECO || 0) / 2).toFixed(2).replace('.', ',') %></p>
              <button class="favorite" onclick="toggleFavorite(this, <%= produto.ID_PRODUTO %>)"><img src="/imagens/Heart.png"></button>
              <button class="cart" onclick="addToCart(<%= produto.ID_PRODUTO %>)"><img src="/imagens/sacola.png" class="img-sacola"></button>
            </article>
          <% }) %>
        <% } else { %>
          <article class="product-card">
            <img src="/imagens/oculos.png" alt="Óculos de sol">
            <h2>Óculos de sol</h2>
            <p class="price">R$12,00</p>
            <button class="favorite"><img src="/imagens/Heart.png"></button>
            <button class="cart" onclick="alert('Produto não disponível')"><img src="/imagens/sacola.png" class="img-sacola"></button>
          </article>
        <% } %>
      </section>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <img src="/imagens/logo2.jpeg" alt="Vintélo" class="footer-image">
      <section class="social-media">
        <p class="p-footer">Siga nossas redes sociais</p>
        <ul class="social-links">
          <li><a href="https://facebook.com" target="_blank" class="social-link"><img src="/imagens/Facebook.png" alt="Facebook"></a></li>
          <li><a href="https://twitter.com" target="_blank" class="social-link"><img src="/imagens/Pinterest.png" alt="Pinterest"></a></li>
          <li><a href="https://www.instagram.com/vintelobrechos" target="_blank" class="social-link"><img src="/imagens/Instagram.png" alt="Instagram"></a></li>
        </ul>
      </section>
      <p class="copyright">©2024 Vintélo. Todos os direitos reservados.</p>
    </footer>
  </section>
  <script src="/js/finalizandocompra.js"></script>
  <script src="/js/frete-calculator.js"></script>
  <script src="/js/perfil-autenticado.js"></script>
  <script src="/js/navegacao.js"></script>
  <script src="/js/favoritos-global.js"></script>
  <script src="/js/sacola-global.js"></script>
  <script>
    // Função para desktop
    async function calcularFreteDesktop() {
      const cepDestino = document.getElementById('cep_frete_desktop').value.replace(/\D/g, '');
      
      if (cepDestino.length !== 8) {
        alert('Digite um CEP válido');
        return;
      }

      const loadingDiv = document.getElementById('frete-loading-desktop');
      const resultDiv = document.getElementById('frete-result-desktop');
      
      loadingDiv.style.display = 'block';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch('/api/calcular-frete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cep_destino: cepDestino, produto_id: 1 })
        });

        const data = await response.json();
        
        if (data.success) {
          mostrarOpcoesEntregaDesktop(data.opcoes);
        } else {
          resultDiv.innerHTML = '<p>Erro ao calcular frete</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<p>Erro ao calcular frete</p>';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }
    
    function mostrarOpcoesEntregaDesktop(opcoes) {
      const resultDiv = document.getElementById('frete-result-desktop');
      let html = '<h4>Opções de entrega:</h4>';
      
      opcoes.forEach((opcao, index) => {
        html += `
          <div class="opcao-frete" onclick="selecionarFreteDesktop('${opcao.name}', '${opcao.price}', '${opcao.delivery_time}')" data-selected="false">
            <span>${opcao.name}</span>
            <span>R$ ${opcao.price}</span>
            <span>${opcao.delivery_time} dias úteis</span>
            <span class="selecionar-btn">Selecionar</span>
          </div>
        `;
      });
      
      resultDiv.innerHTML = html;
    }
    
    function selecionarFreteDesktop(nome, preco, prazo) {
      document.querySelectorAll('#frete-result-desktop .opcao-frete').forEach(opcao => {
        opcao.classList.remove('selecionado');
        opcao.querySelector('.selecionar-btn').textContent = 'Selecionar';
      });
      
      event.target.closest('.opcao-frete').classList.add('selecionado');
      event.target.closest('.opcao-frete').querySelector('.selecionar-btn').textContent = 'Selecionado';
      
      window.freteEscolhido = { nome, preco: parseFloat(preco), prazo };
      
      // Atualizar valores na tela
      const freteSpan = document.querySelector('.pedido-detalhes .detalhe:nth-child(2) span:last-child');
      const totalSpan = document.querySelector('.pedido-detalhes .detalhe.total span:last-child');
      const subtotalText = document.querySelector('.pedido-detalhes .detalhe:first-child span:last-child').textContent;
      
      if (freteSpan) freteSpan.textContent = `R$ ${preco}`;
      
      // Calcular novo total
      const subtotal = parseFloat(subtotalText.replace('R$ ', '').replace(',', '.'));
      const novoTotal = subtotal + parseFloat(preco);
      
      if (totalSpan) totalSpan.textContent = `R$ ${novoTotal.toFixed(2).replace('.', ',')}`;
      
      // Atualizar botão de finalizar
      const btnFinalizar = document.querySelector('.finalizar-compra');
      if (btnFinalizar && btnFinalizar.tagName === 'A') {
        const href = btnFinalizar.getAttribute('href');
        const baseUrl = href.split('?')[0];
        btnFinalizar.setAttribute('href', `${baseUrl}?total=${novoTotal.toFixed(2)}&frete=${preco}&frete_nome=${nome}`);
      }
    }
  </script>
</body>
</html>